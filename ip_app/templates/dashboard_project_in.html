{% extends "test69.html" %}
{% block nav_dash %}active{% endblock nav_dash %}

{% block content %}

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/js/bootstrap.min.js" integrity="sha384-oesi62hOLfzrys4LxRF63OJCXdXDipiYWBnvTl9Y9/TRlw5xlKIEHpNyvvDShgf/" crossorigin="anonymous"></script>

<nav aria-label="breadcrumb" id="dashboard-crumb" class="top-breadcrumb">
    <ol class="breadcrumb breadcrumb-text-light breadcrumb-secondary text-white">
            <li class="breadcrumb-item"><a href="{{url_for('index')}}">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ project_name }}</li>
          </ol>
        </nav>
        


<ul class="nav justify-content-center">
  <li class="nav-item">
    <a class="nav-link disabled" aria-current="page" href="{{url_for('show_tasks_for_project', project_name=project_name)}}">Tabular-View</a>
  </li>
  <li class="nav-item">
    <a class="nav-link active" href="{{url_for('show_grid_view_tasks_for_projects', project_name=project_name)}}"  tabindex="-1" aria-disabled="true">Grid-View</a>
  </li>

</ul>



    <!-- The modal for the adding a task -->
<div class="modal fade" id="modal_add_row" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">New Task for: {{ project_name }} </h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      
      
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <i class="fas fa-user prefix grey-text"></i>
            <label for="task_name" class="form-control-label">Task Name: </label>
            <input type="text" class="form-control" id="task_name" placeholder="New Task for {{ project_name }}">
        </div>

        <div class="md-form mb-5">
          <i class="fas fa-envelope prefix grey-text"></i>
            <label for="assigned_to" class="form-control-label" >Assigned To: </label>
            <input type="text" class="form-control" id="assigned_to" placeholder="Member Name">
        </div>

        <div class="md-form mb-5">
          <i class="fas fa-tag prefix grey-text"></i>
            <label for="eta" class="form-control-label">ETA: </label>
                <input type="text" placeholder="MM/DD/YYYY"
                    onfocus="(this.type='date')" class="form-control" id="eta"  >

        </div>

      </div>
      <div class="modal-footer d-flex justify-content-center">
        <button class="btn btn-unique" id="submit-add-task" data-dismiss="modal">Submit <i class="fas fa-paper-plane-o ml-1"></i></button>
      </div>
    </div>
  </div>
</div>
    <!----------------->



    <!-- My beautiful table that actually displays everything -->
   <table id="task-datatable" class="cell-border" style="width:100%">
        <thead>
            <tr>
                <th></th>

                <th>Task Name</th>
                <th>Assigned To: </th>
                <th>ETA: </th>
                <th>Progress: </th>
            </tr>
        </thead>

    </table>
        
    
    <!----------------->

                    <!-- SCRIPTS -->
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/select/1.3.3/js/dataTables.select.min.js"> </script>

<link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">




        <link rel="stylesheet" href="{{ url_for('static', filename='dashboard_project_in.css') }}">


<script>
$(document).ready(function() {
    

            // This repopulates the data on after adding atleast one task to your DB.
        $.get("/dashboard/<project_name>/get-python-task-data", function(data) {
            console.log($.parseJSON(data))
            populateDataTable(data)
        })

  var t = $('#task-datatable').DataTable({
    "dom": '<"toolbar">frtip',
    language: {
        search: "_INPUT_",
        searchPlaceholder: "Filter..."
    },
  "paging": false,
  "order": [[1, "desc"]], 
  "columnDefs": [
    { "orderable": false, "width": "2%", "targets": 0 }
  ]
} );
    
    $('#task-datatable tbody').on( 'click', 'tr', function () {
        if ( $(this).hasClass('selected') ) {
            $(this).removeClass('selected');
        }
        else {
            t.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
        }
    });

    t.on( 'order.dt search.dt', function () {
        t.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
            cell.innerHTML = i+1;
        } );
    } ).draw();


    $("div.toolbar").html('<ul class="project-ul" id="project-ul"> <button type="button" class="btn btn-outline-secondary editor-create" id="create-task" data-toggle="modal" data-target="#modal_add_row">    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">      <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"></path>      <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"></path></svg> Tasks</button> <button type="button" class="editor-create btn btn-secondary" id="delete-task"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">  <path d="M1.293 1.293a1 1 0 0 1 1.414 0L8 6.586l5.293-5.293a1 1 0 1 1 1.414 1.414L9.414 8l5.293 5.293a1 1 0 0 1-1.414 1.414L8 9.414l-5.293 5.293a1 1 0 0 1-1.414-1.414L6.586 8 1.293 2.707a1 1 0 0 1 0-1.414z"/></svg></button></ul>');
    $('div.dataTables_filter').appendTo(".project-ul");
    
    // reverse the order
    ul = $('#project-ul'); 
    ul.children().each(function(i,li){ul.prepend(li)})

    
 $("#delete-task").click(function () {
 
    console.log(t.row('.selected').index());
    
    if (t.row('.selected').index() >= 0) {
                   
        if(confirm("Are you sure you want to delete this task?")) {

            console.log(t.row('.selected').index());
            
            // if we are here the guy probably said OK
            
            var data_array = t.row('.selected').data();            

            var which_row = t.row('.selected').index();
            var project_name = '{{ project_name }}'; 

            t.row('.selected').remove().draw( false );
            
            // 1 - task name, 2 - assigned to, 3 - eta, 4 - progress bar
            // this is safe ^ because that is how the data is added
            
            
            console.log(which_row);

                // send the data back
            $.post("/delete-task-method", {which_row:which_row, project_name:project_name});
            
                 
            }
        } else {
            alert ("Click on a task first to delete it!");
        }
    });  
  
  

    $("#submit-add-task").click(function () {
        var task_name = $("#task_name").val();
        var member_name = $("#assigned_to").val();
        var eta = $("#eta").val();
        var project_name = '{{ project_name }}'; 
        
        
        if (task_name == "" || member_name == "" || project_name == "") {
            if (confirm("Some fields are left blank!\nAre you sure you'd like to add this task anyway?")){
                    
            } else {
                return;
            }
        }
        
        t.row.add(["", task_name, member_name, eta, "progress_bar"]).draw(false);
        
        // Note to self: 
        //  No need to close it, the button has a nice data-dismiss
        
        
        // This posts the data after you're done adding a new task.
        $.post(         "/post-task-method",  {   task_name: task_name, 
                                    member_name: member_name,
                                    eta: eta,
                                    project_name: project_name    
                                });
    });
    

 } );    
 
 

 
 
function reverse_eta(str){
   return str.split('-').reverse().join('-');
}

function populateDataTable(data) {
    var data1 = JSON.parse(data);
    
    console.log(Object.keys(data1).length);

    // clear the table before populating it with more data
    $("#task-datatable").DataTable().clear();

    var length = Object.keys(data1.tasks).length;
    
    
    for(var i = 1; i < length+1; i++) {
      var task = data1.tasks['task'+i];
      
      $('#task-datatable').dataTable().fnAddData( [
        "",
        task.task_name,
        task.assigned_to,
        reverse_eta(task.eta),
        "Dumb"
      ]);
    }
  }


</script>

{% endblock %}